---
title: "Importance sampling"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=FALSE)
```

```{r echo=FALSE, include=FALSE}
library(dmea)
```
On this report we denote $D$ as the observed-part or extant-species, $+_i$ as the missing-part or extinct-species of the tree and $D^+$ is then the complete phylogenetic tree.  


The EM algorithms consists on two steps. First, we calculate the conditional expectation:

$$ Q(\theta|\theta^*) = E_{\theta^* } [log P(D^+|\theta) | D] $$

and then we performs the maximization:

$$ \theta ^{**} = argmax_{(\theta)} Q( \theta | \theta ^*) $$

Given that the calculation of the conditional expectation is really hard (if not impossible), we use an approximation, sampling complete-phylogenies under a montecarlo approach. This simulations should be sampled from (real density) 

$$ f_{\theta^*} (+_i | D) $$

But instead we sample it from 

$$ g_{\theta^*}(+_i | D) $$

To correct this we re-weigh the approximation of the expectation by importance scaling:

$$w_i =  \frac{f_{\theta^*} (+_i | D)}{g_{\theta^*}(+_i | D)} $$


Thus, the montecarlo approximation we are using has the form

$$ E_{\theta^* } [log P(D^+|\theta) | D] \approx \frac{1}{N} \sum^{N}_{i=1} log P(D_i^+ | \theta)  \frac{f_{\theta^*} (+_i | D)}{g_{\theta^*}(+_i | D)}$$

Moreover, 

$$ f_{ \theta^* } (+_i | D) = \frac{f_{\theta^*} (+_i \cap D)}{f_{\theta^*} (D)} = c \cdot f_{\theta^*} (D^+) $$ 

where $c = \frac{1}{f_{\theta^*} (D)}$ does not depends on the $i$-iteration of the EM algorithm. And $f_{\theta^*} (D^+)$ is the density function of the complete phylogenetic tree. 

Thus, we calculate $g_{\theta^*}(+_i | D)$ within the ```rec_tree``` function which calculates the density $g$ at the same time that simulates the missing species. The part of the code which does that is the one below

```{r, eval=FALSE}
t_spe = rexp(1,s)
prob = prob*dexp(t_spe,rate=s)  #adding the speciation event to g
if (t_spe < cwt){
  t_ext = rexp(1,mu0)
  prob = prob*dexp(t_ext,rate=mu0) #adding extinction event to g
```

and the same code calculates $f_{\theta^*} (D^+)$ just taking the exponential of the -log-likelihood function the the complete reconstructed tree. After that we calculate the weight:

```{r, eval=FALSE}
f_n = exp(-llik(b=pars,n=n,E=E,t=wt))
weight = f_n/prob
```

##### Implementation

To have a better idea on how this implementation look like we do some simple observations. 

We start simulating a whole tree

```{r}
st <- sim_phyl()
plot(st$newick)
```  

Them we drop extinct species

```{r}
st2 <- drop.fossil(st$newick)
plot(st2)
```

we transform phylo format into branching-times, number of species, and topology vectors

```{r}
st2 <- phylo2p(st2)
```

Now we simulate a complete tree (extinct+extans species) based on the observed tree (extant species only) 

```{r, warning=FALSE}
st3 <- rec_tree(wt=st2$t)
```

and we observe the calculated weight for this tree

```{r}
st3$weight
```

it seems very small, we can see also the values of $f$ and $g$ to have an idea of the order of them 

```{r}
st3$f_n
st3$prob
```


This is a random process, if we do it again we end with another complete-tree and its corresponding weight, we do it for 30 iterations just to have an idea of the variability of the weight


```{r, warning=FALSE} 
for(i in 1:100){
st3 <- rec_tree(wt=st2$t)
print(st3$weight)
}
```
So, a first observation, <span style="color:red">  THE VALUES of g anf f ARE REALLY SMALL AND VARIES A LOT WITH DIFFERENT TREES. That is amaking a lot of numerical inestabilities. </span>


***



#### More code
In case is useful, the function used to simulate the extinct part of the recontructe tree is the one below




<!--
Where, in the case of  $f_{\theta^*} (+_i | D)  = \prod_i P_{ms_i}$, and $P_{ms_i}$ corresponds to the probability for the missing species number $i$. That is 

$$ P_{ms_i} = \displaystyle\underbrace{\left(\sum \lambda\right)_{i} e^{-t_i(\sum \lambda)_i} \frac{1}{n_i}}_{speciation} \displaystyle\underbrace{\frac{\mu e^{-t_i \mu}}{1-e^{-\mu rT}}}_{extinction} $$

Then, for the case of DD we have 

$$ P_{ms_i} = n_i(\lambda_0-\beta n_i)  e^{-t_i(n_i(\lambda_0-\beta n_i))} \frac{1}{n_i} \frac{\mu e^{-t_i^{ext} \mu}}{1-e^{-\mu(ct-bt_i)}} $$
 --> 
